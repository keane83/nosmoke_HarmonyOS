import { router } from '@kit.ArkUI';
import { SmokingDataManager } from '../utils/SmokingDataManager';
import { TriggerDataManager } from '../utils/TriggerDataManager';
import { preferences } from '@kit.ArkData';
import { AppContext } from '../utils/AppContext';

interface Achievement {
  id: string;
  name: string;
  description: string;
  unlocked: boolean;
  icon: string;
  progress?: number; // è¿›åº¦ï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºè¿›åº¦ï¼‰
  target?: number; // ç›®æ ‡å€¼ï¼ˆå¯é€‰ï¼‰
}

interface PriceSettings {
  price: number;
  size: number;
}

@Entry
@Component
struct Achievements {
  @State achievements: Achievement[] = [
    {
      id: '1',
      name: 'è™šæ‹Ÿå¸çƒŸè€…',
      description: 'å®Œæˆ 10 æ¬¡è™šæ‹Ÿå¸çƒŸ',
      unlocked: false,
      icon: 'ğŸ’¨',
      progress: 0,
      target: 10
    },
    {
      id: '2',
      name: 'çœé’±è¾¾äºº',
      description: 'ç´¯è®¡èŠ‚çœ 500 å…ƒ',
      unlocked: false,
      icon: 'ğŸ’°',
      progress: 0,
      target: 500
    },
    {
      id: '3',
      name: 'ä¸€å‘¨åšæŒ',
      description: 'è¿ç»­ 7 å¤©éƒ½æœ‰è™šæ‹ŸçƒŸè®°å½•',
      unlocked: false,
      icon: 'ğŸ†'
    },
    {
      id: '4',
      name: 'è®°å½•ä¹ æƒ¯',
      description: 'è¿ç»­ 3 å¤©è®°å½•è¯±å› ',
      unlocked: false,
      icon: 'ğŸ“'
    }
  ];

  private priceStore: preferences.Preferences | null = null;

  async aboutToAppear() {
    await this.checkAchievements();
  }

  // åˆå§‹åŒ–ä»·æ ¼è®¾ç½®å­˜å‚¨
  async initPriceStore() {
    if (!this.priceStore) {
      const context = AppContext.getContext();
      if (!context) {
        console.error('Contextæœªè®¾ç½®');
        return;
      }
      this.priceStore = await preferences.getPreferences(context, 'price_settings');
    }
  }

  // è·å–ä»·æ ¼è®¾ç½®
  async getPriceSettings(): Promise<PriceSettings> {
    await this.initPriceStore();
    const defaultSettings: PriceSettings = { price: 20, size: 20 };
    
    if (!this.priceStore) {
      return defaultSettings;
    }
    
    try {
      const price = await this.priceStore.get('pack_price', 20) as number;
      const size = await this.priceStore.get('pack_size', 20) as number;
      const settings: PriceSettings = { price, size };
      return settings;
    } catch (error) {
      console.error('è·å–ä»·æ ¼è®¾ç½®å¤±è´¥: ' + JSON.stringify(error));
      return defaultSettings;
    }
  }

  // è®¡ç®—èŠ‚çœé‡‘é¢
  async calculateTotalSaved(): Promise<number> {
    try {
      const totalCigarettes = await SmokingDataManager.getTotalCigarettes();
      const priceSettings = await this.getPriceSettings();
      const pricePerCigarette = priceSettings.size > 0 ? priceSettings.price / priceSettings.size : 0;
      return totalCigarettes * pricePerCigarette;
    } catch (error) {
      console.error('è®¡ç®—èŠ‚çœé‡‘é¢å¤±è´¥: ' + JSON.stringify(error));
      return 0;
    }
  }

  // æ£€æŸ¥ä¸€å‘¨åšæŒï¼ˆè¿ç»­7å¤©éƒ½æœ‰è™šæ‹ŸçƒŸè®°å½•ï¼‰
  async checkWeekStreak(): Promise<boolean> {
    try {
      const weekData = await SmokingDataManager.getWeekData();
      // æ£€æŸ¥æœ¬å‘¨7å¤©æ˜¯å¦éƒ½æœ‰è®°å½•ï¼ˆçƒŸæ•° > 0ï¼‰
      for (let i = 0; i < 7; i++) {
        if (weekData[i] <= 0) {
          return false;
        }
      }
      return true;
    } catch (error) {
      console.error('æ£€æŸ¥ä¸€å‘¨åšæŒå¤±è´¥: ' + JSON.stringify(error));
      return false;
    }
  }

  // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
  private formatDate(date: Date): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  // æ£€æŸ¥è®°å½•ä¹ æƒ¯ï¼ˆè¿ç»­3å¤©è®°å½•è¯±å› ï¼‰
  async checkTriggerStreak(): Promise<boolean> {
    try {
      const records = await TriggerDataManager.getAllRecords();
      if (records.length < 3) {
        return false;
      }

      // æŒ‰æ—¥æœŸåˆ†ç»„è®°å½•
      const recordsByDate = new Map<string, number>();
      records.forEach(record => {
        const date = new Date(record.timestamp);
        const dateStr = this.formatDate(date);
        recordsByDate.set(dateStr, (recordsByDate.get(dateStr) || 0) + 1);
      });

      // æ£€æŸ¥æœ€è¿‘3å¤©æ˜¯å¦è¿ç»­
      const today = new Date();
      for (let i = 0; i < 3; i++) {
        const checkDate = new Date(today);
        checkDate.setDate(today.getDate() - i);
        const dateStr = this.formatDate(checkDate);
        
        if (!recordsByDate.has(dateStr)) {
          return false;
        }
      }

      return true;
    } catch (error) {
      console.error('æ£€æŸ¥è®°å½•ä¹ æƒ¯å¤±è´¥: ' + JSON.stringify(error));
      return false;
    }
  }

  // æ£€æŸ¥å¹¶æ›´æ–°æˆå°±çŠ¶æ€
  async checkAchievements() {
    try {
      // 1. è™šæ‹Ÿå¸çƒŸè€…ï¼šç´¯è®¡è™šæ‹ŸçƒŸæ•° >= 10
      const totalCigarettes = await SmokingDataManager.getTotalCigarettes();
      const achievement1 = this.achievements.find(a => a.id === '1');
      if (achievement1) {
        achievement1.progress = totalCigarettes;
        achievement1.unlocked = totalCigarettes >= 10;
      }

      // 2. çœé’±è¾¾äººï¼šç´¯è®¡èŠ‚çœ >= 500å…ƒ
      const totalSaved = await this.calculateTotalSaved();
      const achievement2 = this.achievements.find(a => a.id === '2');
      if (achievement2) {
        achievement2.progress = totalSaved;
        achievement2.unlocked = totalSaved >= 500;
      }

      // 3. ä¸€å‘¨åšæŒï¼šè¿ç»­7å¤©éƒ½æœ‰è™šæ‹ŸçƒŸè®°å½•
      const weekStreak = await this.checkWeekStreak();
      const achievement3 = this.achievements.find(a => a.id === '3');
      if (achievement3) {
        achievement3.unlocked = weekStreak;
      }

      // 4. è®°å½•ä¹ æƒ¯ï¼šè¿ç»­3å¤©è®°å½•è¯±å› 
      const triggerStreak = await this.checkTriggerStreak();
      const achievement4 = this.achievements.find(a => a.id === '4');
      if (achievement4) {
        achievement4.unlocked = triggerStreak;
      }

      // æ›´æ–°çŠ¶æ€ä»¥è§¦å‘UIåˆ·æ–°
      this.achievements = [...this.achievements];
      
      console.info(`æˆå°±æ£€æŸ¥å®Œæˆ: è™šæ‹Ÿå¸çƒŸè€…=${achievement1?.unlocked}, çœé’±è¾¾äºº=${achievement2?.unlocked}, ä¸€å‘¨åšæŒ=${achievement3?.unlocked}, è®°å½•ä¹ æƒ¯=${achievement4?.unlocked}`);
    } catch (error) {
      console.error('æ£€æŸ¥æˆå°±å¤±è´¥: ' + JSON.stringify(error));
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ ï¼Œå¸¦å…³é—­æŒ‰é’®
      Row() {
        Button() {
          Image($r('sys.media.ohos_ic_back'))
            .width(20)
            .height(20)
            .fillColor('#333')
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.White)
        .onClick(() => {
          router.back();
        })

        Text('æˆå°±ç³»ç»Ÿ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .layoutWeight(1)
          .textAlign(TextAlign.Center)

        // å ä½ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
        Column()
          .width(40)
          .height(40)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20 })
      .margin({ bottom: 30 })

      // æˆå°±ç»Ÿè®¡
      Row() {
        Text(`å·²è§£é”: ${this.achievements.filter(a => a.unlocked).length} / ${this.achievements.length}`)
          .fontSize(18)
          .fontColor('#333')
      }
      .width('90%')
      .margin({ bottom: 20 })

      // æˆå°±åˆ—è¡¨
      Grid() {
        ForEach(this.achievements, (achievement: Achievement) => {
          GridItem() {
            Column() {
              Text(achievement.icon)
                .fontSize(40)
                .opacity(achievement.unlocked ? 1 : 0.3)
              
              Text(achievement.name)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor(achievement.unlocked ? '#333' : '#999')
                .margin({ top: 10 })
              
              Text(achievement.description)
                .fontSize(12)
                .fontColor('#666')
                .margin({ top: 5 })
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
              
              // æ˜¾ç¤ºè¿›åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
              if (achievement.progress !== undefined && achievement.target !== undefined) {
                Text(`${achievement.progress}/${achievement.target}`)
                  .fontSize(11)
                  .fontColor(achievement.unlocked ? '#4CAF50' : '#999')
                  .margin({ top: 5 })
              }
            }
            .width('100%')
            .height('100%')
            .padding(15)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(achievement.unlocked ? '#FFF9C4' : '#FFFFFF')
            .borderRadius(10)
            .border({
              width: achievement.unlocked ? 2 : 1,
              color: achievement.unlocked ? '#FFD700' : '#E0E0E0',
              radius: 10
            })
            .shadow({ radius: 2, color: '#E0E0E0', offsetX: 0, offsetY: 1 })
          }
        })
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(15)
      .rowsGap(15)
      .width('90%')
      .layoutWeight(1)
    }
    .expandSafeArea()
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    .padding(20)
  }
}
